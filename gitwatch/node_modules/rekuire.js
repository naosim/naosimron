var fs = require('fs');

var getDirectories = function(root) {
  var dirs = [];
  var pushSubDir = function(path) {
    fs.readdirSync(path)
    .filter(function(file) {
      var filePath = path + '/' + file;
      return file.charAt(0) != '.' && file != 'node_modules' && fs.statSync(filePath).isDirectory();
    })
    .map(function(file) { return path + '/' + file })
    .forEach(function(file) {
      dirs.push(file);
      pushSubDir(file);
    });
  };
  pushSubDir(root);
  return dirs;
};

var cache = {};

(function(global) {
  "use strict";
  if (!("process" in global)) return;

  var rekuire = function(libname, rootDir) {
    try {
      return require(libname);
    } catch(e) {}
    if(libname.indexOf('.js') == -1) libname += '.js';
    console.log('input ', libname)

    // cache
    if(cache[libname]) {
      return require(cache[libname]);
    }

    // same dir
    if(fs.existsSync(rootDir + '/' + libname)) {
      cache[libname] = rootDir + '/' + libname;
      return require(rootDir + '/' + libname);
    };

    // find
    rootDir = rootDir || process.env.PWD;
    var dirs = getDirectories(rootDir);
    for(var i = 0; i < dirs.length; i++) {
      if(fs.existsSync(dirs[i] + '/' + libname)) {
        cache[libname] = dirs[i] + '/' + libname;
        return require(dirs[i] + '/' + libname);
      };
    }
  };
  module.exports = rekuire;

})((this || 0).self || global);
